<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å€‹äººæŠ•è³‡çµ„åˆå„€è¡¨æ¿ (V30 - åµéŒ¯æ¨¡å¼)</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <style>
        /* åŸºç¤ä½ˆå±€èˆ‡å­—é«” (V17 æ¨£å¼) */
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background-color: #f4f6f8; margin: 0; padding: 0; display: flex; min-height: 100vh; }
        .sidebar { width: 250px; background-color: #2c3b41; color: #fff; padding-top: 20px; box-shadow: 2px 0 5px rgba(0,0,0,0.1); flex-shrink: 0; }
        .sidebar h2 { margin: 0 0 30px 20px; font-size: 1.2rem; color: #f8f9fa; }
        .sidebar nav a { display: block; padding: 12px 20px; text-decoration: none; color: #c0c0c0; transition: background-color 0.3s, color 0.3s; border-left: 3px solid transparent; }
        .sidebar nav a:hover { background-color: #3d4a52; color: #fff; }
        .sidebar nav a.active { background-color: #1e282c; color: #fff; border-left: 3px solid #00aaff; }

        /* ä¸»å…§å®¹å€åŸŸ */
        .main-content { flex-grow: 1; padding: 20px; overflow-y: auto; }
        .container { max-width: 100%; margin: 0; }
        
        /* æ¨™é¡Œå¡ç‰‡ */
        .header { background: #fff; padding: 20px; border-radius: 5px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); margin-bottom: 20px; display: flex; justify-content: space-between; align-items: center; }
        .header h1 { margin: 0; color: #333; font-size: 1.5rem; }
        .header p { color: #666; margin: 5px 0 0; font-size: 0.9rem; }
        .refresh-btn { background-color: #00aaff; color: white; border: none; padding: 8px 15px; border-radius: 5px; cursor: pointer; transition: background 0.3s; }
        .refresh-btn:hover { background-color: #0090e0; }
        
        /* KPI, Chart, Table æ¨£å¼ */
        .kpi-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-bottom: 20px; }
        .kpi-card { background: #fff; padding: 20px; border-radius: 5px; border-top: 3px solid #00aaff; box-shadow: 0 2px 5px rgba(0,0,0,0.05); text-align: center; }
        .kpi-title { font-size: 0.9em; color: #888; margin-bottom: 5px; }
        .kpi-value { font-size: 1.5em; font-weight: bold; color: #333; }
        .positive { color: #28a745; }
        .negative { color: #dc3545; }

        .charts-container { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px; }
        .chart-card { 
            background: #fff; 
            padding: 20px; 
            border-radius: 5px; 
            box-shadow: 0 2px 5px rgba(0,0,0,0.05); 
            height: 380px; 
            display: flex; 
            flex-direction: column;
        }
        
        .chart-card canvas { flex-grow: 1; max-height: 100%; }
        
        .table-container { background: #fff; padding: 20px; border-radius: 5px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); overflow-x: auto; }
        table { width: 100%; border-collapse: collapse; margin-top: 10px; min-width: 600px; }
        th, td { padding: 12px; text-align: left; border-bottom: 1px solid #eee; }
        th { background-color: #f8f9fa; color: #555; cursor: pointer; user-select: none; }
        tr:hover { background-color: #f1f1f1; }
        .loading { text-align: center; padding: 20px; color: #666; font-style: italic; }

        @media (max-width: 768px) {
            .sidebar { width: 100%; height: auto; padding: 10px 0; }
            .sidebar h2 { display: none; }
            .sidebar nav { display: flex; flex-wrap: wrap; justify-content: center; }
            .charts-container { grid-template-columns: 1fr; }
            .chart-card { height: 350px; padding: 20px; } 
            .header { flex-direction: column; align-items: flex-start; }
            .refresh-btn { margin-top: 10px; }
            body { flex-direction: column; }
        }
        
        /* åˆ†é å…§å®¹éš±è— */
        .tab-content { display: none; }
        .tab-content.active { display: block; }
        
        /* æ ¸å¿ƒå­˜è‚¡çš„ç‰¹æ®Š KPI é¡è‰² */
        #core .kpi-card { border-top: 3px solid #28a745; } 

    </style>
</head>
<body>

<div class="sidebar">
    <h2>å€‹äººæŠ•è³‡çµ„åˆ</h2>
    <nav>
        <a href="#" class="tab-link active" data-tab="dashboard">ğŸ“Š å„€è¡¨æ¿</a>
        <a href="#" class="tab-link" data-tab="core">ğŸ’° æ ¸å¿ƒå­˜è‚¡</a>
        <a href="#" class="tab-link" data-tab="asset">ğŸ—ºï¸ è³‡ç”¢é…ç½®</a>
    </nav>
</div>

<div class="main-content">
    <div class="container">
        
        <div id="dashboard" class="tab-content active">
            <div class="header">
                <div>
                    <h1>è³‡ç”¢ç¸½è¦½ (å„€è¡¨æ¿)</h1>
                    <p>è³‡æ–™ä¾†æºï¼šGoogle è©¦ç®—è¡¨ (å³æ™‚é€£å‹•) | <span id="lastUpdated">æ›´æ–°ä¸­...</span></p>
                </div>
                <button class="refresh-btn" onclick="fetchData()">é‡æ–°æ•´ç†</button>
            </div>

            <div class="kpi-grid">
                <div class="kpi-card">
                    <div class="kpi-title">ç¸½æŠ•å…¥æˆæœ¬</div>
                    <div class="kpi-value" id="kpi-cost">-</div>
                </div>
                <div class="kpi-card">
                    <div class="kpi-title">ç›®å‰ç¸½å¸‚å€¼</div>
                    <div class="kpi-value" id="kpi-value">-</div>
                </div>
                <div class="kpi-card">
                    <div class="kpi-title">å¸³é¢ç¸½æç›Š</div>
                    <div class="kpi-value" id="kpi-pl">-</div>
                </div>
                <div class="kpi-card">
                    <div class="kpi-title">ç¸½å ±é…¬ç‡</div>
                    <div class="kpi-value" id="kpi-pct">-</div>
                </div>
            </div>

            <div class="charts-container">
                <div class="chart-card">
                    <h3>å‰ 10 å¤§æŒå€‰ (æŒ‰å¸‚å€¼)</h3>
                    <canvas id="topHoldingsChart"></canvas>
                </div>
                <div class="chart-card">
                    <h3>ä¸»è¦ç²åˆ©/è™§æä¾†æº (é‡‘é¡)</h3>
                    <canvas id="plChart"></canvas>
                </div>
            </div>

            <div class="table-container">
                <h3>æŒè‚¡æ˜ç´° (é»æ“Šæ¨™é¡Œå¯æ’åº)</h3>
                <table id="holdingsTable">
                    <thead>
                        <tr>
                            <th onclick="sortTable(0)">ä»£ç¢¼</th>
                            <th onclick="sortTable(1)">åç¨±</th>
                            <th onclick="sortTable(2)">åº«å­˜æˆæœ¬</th>
                            <th onclick="sortTable(3)">åº«å­˜ç¾å€¼</th>
                            <th onclick="sortTable(4)">åº«å­˜æç›Š</th>
                            <th onclick="sortTable(5)">å ±é…¬ç‡ %</th>
                        </tr>
                    </thead>
                    <tbody id="tableBody">
                        <tr><td colspan="6" class="loading">æ­£åœ¨è®€å– Google è©¦ç®—è¡¨è³‡æ–™...</td></tr>
                    </tbody>
                </table>
            </div>
        </div>

        <div id="core" class="tab-content">
            <div class="header" style="border-top: 3px solid #28a745;">
                <div>
                    <h1>æ ¸å¿ƒå­˜è‚¡ç¸½è¦½ (V30 åµéŒ¯æ¨¡å¼)</h1>
                    <p>è³‡æ–™ä¾†æºï¼šGoogle è©¦ç®—è¡¨ (GID: 837341455) | <span id="coreLastUpdated">å°šæœªè¼‰å…¥...</span></p>
                </div>
                <button class="refresh-btn" onclick="fetchCoreData()">é‡æ–°æ•´ç†æ ¸å¿ƒæ•¸æ“š</button>
            </div>
            
            <div class="kpi-grid">
                <div class="kpi-card">
                    <div class="kpi-title">ç›®å‰ç¸½å¸‚å€¼</div>
                    <div class="kpi-value" id="core-kpi-value">-</div>
                </div>
                <div class="kpi-card">
                    <div class="kpi-title">å¸³ä¸Šç¸½æç›Š</div>
                    <div class="kpi-value" id="core-kpi-pl">-</div>
                </div>
                <div class="kpi-card">
                    <div class="kpi-title">åˆè¨ˆæœˆé…æ¯ (é ä¼°)</div>
                    <div class="kpi-value" id="core-kpi-monthly-div">-</div>
                </div>
                <div class="kpi-card">
                    <div class="kpi-title">åˆè¨ˆå¹´é…æ¯ (é ä¼°)</div>
                    <div class="kpi-value" id="core-kpi-annual-div">-</div>
                </div>
                <div class="kpi-card">
                    <div class="kpi-title">ç¸½æ®–åˆ©ç‡ (å¸‚å€¼è¨ˆç®—)</div>
                    <div class="kpi-value" id="core-kpi-yield">-</div>
                </div>
                <div class="kpi-card">
                    <div class="kpi-title">è‚¡å‚µæ¯”ä¾‹ (å¸‚å€¼)</div>
                    <div class="kpi-value" id="core-kpi-ratio">-</div>
                </div>
            </div>

            <div class="charts-container" style="display: none;">
                <div class="chart-card"><canvas id="coreProportionChart"></canvas></div>
                <div class="chart-card"><canvas id="coreAssetChart"></canvas></div>
                <div class="chart-card"><canvas id="corePLChart"></canvas></div>
            </div>

            <div class="table-container">
                <h3>æ ¸å¿ƒæŒè‚¡æ˜ç´° (V30 åµéŒ¯è¼¸å‡º)</h3>
                <table id="coreHoldingsTable">
                    <thead>
                        <tr>
                            <th colspan="8" style="text-align: center; background-color: #ffe0b2;">åŸå§‹ CSV è³‡æ–™è¼¸å‡ºå€</th>
                        </tr>
                    </thead>
                    <tbody id="coreTableBody">
                        <tr><td colspan="8" class="loading">ç­‰å¾…è¼‰å…¥æ ¸å¿ƒå­˜è‚¡è³‡æ–™...</td></tr>
                    </tbody>
                </table>
            </div>
        </div>

        <div id="asset" class="tab-content">
             <div class="table-container" style="border-top: 3px solid #dc3545;">
                <h1>è³‡ç”¢é…ç½®èˆ‡é¢¨éšªç®¡ç†</h1>
                <p>æ­¤è™•å°‡å¯¦ä½œæ‚¨è³‡ç”¢é…ç½®åˆ†é çš„ $\text{KPI}$ èˆ‡åœ–è¡¨ã€‚</p>
                <div style="height: 300px; text-align: center; color: #666; padding-top: 50px;">
                    <h3>[æœªä¾†å…§å®¹å€å¡Š]</h3>
                    <p>ä¾‹å¦‚ï¼šåœ“é¤…åœ–é¡¯ç¤ºè³‡ç”¢é¡åˆ¥åˆ†ä½ˆã€é¢¨éšªå€¼è¨ˆç®—ã€‚</p>
                </div>
            </div>
        </div>

    </div>
</div>

<script>
    // æ‚¨çš„ Google Sheet CSV é€£çµ (ä¸»å„€è¡¨æ¿ GID)
    const DASHBOARD_GID = '947201725';
    // æ‚¨çš„ Google Sheet CSV é€£çµ (æ ¸å¿ƒå­˜è‚¡ GID)
    const CORE_GID = '837341455'; 
    
    // Google Sheet Base URL (ä¿æŒä¸è®Š)
    const googleSheetBaseUrl = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vTfHLeQ3OVmKrVEQXUwD7VUiC5Hgnp8DORBJsL8Rs_434tzm7frIzs5hAsFsVgDL7fZM4ySENKHw5Fy/pub?single=true&output=csv&gid=';
    
    // Chart Instances
    let dashboardChart1 = null;
    let dashboardChart2 = null;
    let coreChart1 = null;
    let coreChart2 = null;
    let coreChart3 = null;


    // --- å´é‚Šæ¬„åˆ‡æ›é‚è¼¯ (V28 ä¿®æ­£: é»æ“Šæ ¸å¿ƒå­˜è‚¡æ™‚è§¸ç™¼æ–°å‡½æ•¸) ---
    document.querySelectorAll('.tab-link').forEach(link => {
        link.addEventListener('click', function(e) {
            e.preventDefault();
            const targetTab = this.getAttribute('data-tab');

            document.querySelectorAll('.tab-link').forEach(l => l.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));

            this.classList.add('active');
            document.getElementById(targetTab).classList.add('active');

            if (targetTab === 'dashboard' && window.lastDashboardData) {
                setTimeout(() => updateDashboardCharts(window.lastDashboardData), 50); 
            } else if (targetTab === 'core' && !window.lastCoreData) {
                // é¦–æ¬¡é»æ“Šæ ¸å¿ƒå­˜è‚¡æ™‚ï¼Œè¼‰å…¥åµéŒ¯æ•¸æ“š
                fetchCoreData();
            }
        });
    });

    // CSV è§£æå™¨ (V17 ç©©å®šç‰ˆæœ¬) - ç‚ºäº†ä¿æŒ fetchData ç©©å®šï¼Œæ­¤å‡½æ•¸ä»ä¿ç•™
    function parseCSVLine(text) {
        const result = [];
        let startValueIndex = 0;
        let inQuotes = false;
        
        for (let i = 0; i < text.length; i++) {
            if (text[i] === '"') {
                inQuotes = !inQuotes;
            } else if (text[i] === ',' && !inQuotes) {
                let val = text.substring(startValueIndex, i);
                if (val.startsWith('"') && val.endsWith('"')) {
                    val = val.substring(1, val.length - 1);
                }
                result.push(val.trim());
                startValueIndex = i + 1;
            }
        }
        let val = text.substring(startValueIndex);
        if (val.startsWith('"') && val.endsWith('"')) {
            val = val.substring(1, val.length - 1);
        }
        result.push(val.trim());
        return result;
    }

    const cleanNum = (str) => {
        const cleanedStr = String(str).replace(/,/g, '').replace(/%/g, '');
        if (cleanedStr.trim() === '') return 0;
        return parseFloat(cleanedStr) || 0;
    };


    // =========================================================
    // å„€è¡¨æ¿è³‡æ–™è™•ç† (ç¶­æŒ V17 åŸå§‹ç©©å®šé‚è¼¯)
    // =========================================================

    async function fetchData() {
        // ... (ä¿æŒ V17 åŸå§‹é‚è¼¯ä¸è®Š)
        document.getElementById('tableBody').innerHTML = '<tr><td colspan="6" class="loading">æ­£åœ¨æ›´æ–°è³‡æ–™...</td></tr>';
        document.getElementById('lastUpdated').innerText = 'æ›´æ–°ä¸­...';

        try {
            const proxyUrl = `https://api.allorigins.win/raw?url=${encodeURIComponent(googleSheetBaseUrl + DASHBOARD_GID)}&timestamp=${new Date().getTime()}`;
            const response = await fetch(proxyUrl);
            
            if (!response.ok) throw new Error('ç¶²è·¯å›æ‡‰éŒ¯èª¤ã€‚');
            const data = await response.text();
            const rows = data.split(/\r\n|\n/).slice(1);
            
            const portfolioData = rows.map(row => {
                if (!row.trim()) return null;
                const cols = parseCSVLine(row);
                if (cols.length < 12) return null; 

                // V17 åŸå§‹æ•¸æ“šè§£æï¼šéŒ¯èª¤çš„æ¬„ä½å®šä½ (I=8, J=9, K=10, L=11)
                return {
                    code: cols[0],             
                    name: cols[1],             
                    cost: cleanNum(cols[8]),   
                    value: cleanNum(cols[9]),  
                    pl: cleanNum(cols[10]),    
                    pct: cleanNum(cols[11])    
                };
            }).filter(item => item !== null && item.cost !== 0); 

            if (portfolioData.length === 0) throw new Error("è§£æå¾Œæ²’æœ‰æœ‰æ•ˆçš„æŠ•è³‡çµ„åˆæ•¸æ“šã€‚");

            window.lastDashboardData = portfolioData; 
            updateDashboard(portfolioData);
            
            const now = new Date();
            document.getElementById('lastUpdated').innerText = `æœ€å¾Œæ›´æ–°: ${now.getHours().toString().padStart(2,'0')}:${now.getMinutes().toString().padStart(2,'0')}:${now.getSeconds().toString().padStart(2,'0')}`;

        } catch (error) {
            console.error('å„€è¡¨æ¿è®€å–å¤±æ•—:', error);
            document.getElementById('tableBody').innerHTML = `<tr><td colspan="6" class="negative" style="text-align:center"><strong>è®€å–è³‡æ–™å¤±æ•—ï¼</strong><br><small>è«‹å˜—è©¦ç¡¬æ€§é‡æ–°æ•´ç† (Ctrl/Cmd + Shift + R)ã€‚</small></td></tr>`;
            document.getElementById('lastUpdated').innerText = 'æ›´æ–°å¤±æ•—';
        }
    }

    // å„€è¡¨æ¿ KPI å’Œ Charts å‡½æ•¸ (ç‚ºäº†ä¿æŒç¨‹å¼ç¢¼å®Œæ•´æ€§ï¼Œä¿ç•™çµæ§‹ï¼Œä½†æ ¸å¿ƒé‚è¼¯å·²åœ¨ V17 ä¸­ç¢ºèªç©©å®š)
    function updateDashboard(data) {
        const totalCost = data.reduce((acc, curr) => acc + curr.cost, 0);
        const totalValue = data.reduce((acc, curr) => acc + curr.value, 0);
        const totalPL = totalValue - totalCost; 
        const totalPct = totalCost > 0 ? (totalPL / totalCost) * 100 : 0;

        document.getElementById('kpi-cost').innerText = parseInt(totalCost).toLocaleString();
        document.getElementById('kpi-value').innerText = parseInt(totalValue).toLocaleString();
        
        const plEl = document.getElementById('kpi-pl');
        plEl.innerText = (totalPL >= 0 ? '+' : '') + parseInt(totalPL).toLocaleString();
        plEl.className = `kpi-value ${totalPL >= 0 ? 'positive' : 'negative'}`;
        
        const pctEl = document.getElementById('kpi-pct');
        pctEl.innerText = (totalPct >= 0 ? '+' : '') + totalPct.toFixed(2) + '%';
        pctEl.className = `kpi-value ${totalPct >= 0 ? 'positive' : 'negative'}`;

        updateDashboardCharts(data);

        const tableBody = document.getElementById('tableBody');
        tableBody.innerHTML = '';
        
        [...data].sort((a, b) => b.value - a.value).forEach(item => {
            const row = document.createElement('tr');
            const plClass = item.pl >= 0 ? 'positive' : 'negative';
            row.innerHTML = `
                <td>${item.code}</td>
                <td>${item.name}</td>
                <td>${Math.round(item.cost).toLocaleString()}</td>
                <td>${Math.round(item.value).toLocaleString()}</td>
                <td class="${plClass}">${Math.round(item.pl).toLocaleString()}</td>
                <td class="${plClass}">${item.pct.toFixed(2)}%</td>
            `;
            tableBody.appendChild(row);
        });
    }

    function updateDashboardCharts(data) {
        if (dashboardChart1) dashboardChart1.destroy();
        if (dashboardChart2) dashboardChart2.destroy();
        
        // åœ–è¡¨ 1: å‰ 10 å¤§æŒå€‰ (æŒ‰å¸‚å€¼)
        const sortedByValue = [...data].sort((a, b) => b.value - a.value).slice(0, 10);
        dashboardChart1 = new Chart(document.getElementById('topHoldingsChart'), {
            type: 'bar',
            data: {
                labels: sortedByValue.map(i => i.name),
                datasets: [{ label: 'åº«å­˜ç¾å€¼', data: sortedByValue.map(i => i.value), backgroundColor: '#00aaff', borderRadius: 4 }]
            },
            options: { indexAxis: 'y', responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } }, scales: { x: { beginAtZero: true } } }
        });

        // åœ–è¡¨ 2: ä¸»è¦æç›Šä¾†æº
        const sortedByPL = [...data].sort((a, b) => b.pl - a.pl);
        const topGainers = sortedByPL.filter(i => i.pl > 0).slice(0, 5); 
        const topLosers = sortedByPL.filter(i => i.pl < 0).slice(-5);
        const plChartData = [...new Set([...topGainers, ...topLosers])].filter(item => item.pl !== 0).sort((a, b) => b.pl - a.pl); 
        
        dashboardChart2 = new Chart(document.getElementById('plChart'), {
            type: 'bar',
            data: {
                labels: plChartData.map(i => i.name),
                datasets: [{
                    label: 'æç›Šé‡‘é¡',
                    data: plChartData.map(i => i.pl),
                    backgroundColor: plChartData.map(i => i.pl >= 0 ? '#28a745' : '#dc3545'),
                    borderRadius: 4
                }]
            },
            options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } }, scales: { y: { beginAtZero: false } } }
        });
    }

    // =========================================================
    // æ ¸å¿ƒå­˜è‚¡è³‡æ–™è™•ç† (V30 åµéŒ¯æ¨¡å¼)
    // =========================================================

    async function fetchCoreData() {
        // é‡ç½® KPI ç‚º '-' 
        document.getElementById('core-kpi-value').innerText = '-';
        document.getElementById('core-kpi-pl').innerText = '-';
        document.getElementById('core-kpi-monthly-div').innerText = '-';
        document.getElementById('core-kpi-annual-div').innerText = '-';
        document.getElementById('core-kpi-yield').innerText = '-';
        document.getElementById('core-kpi-ratio').innerText = '-';


        document.getElementById('coreTableBody').innerHTML = '<tr><td colspan="8" class="loading">æ­£åœ¨è®€å–æ ¸å¿ƒå­˜è‚¡è³‡æ–™...</td></tr>';
        document.getElementById('coreLastUpdated').innerText = 'æ›´æ–°ä¸­...';

        try {
            const proxyUrl = `https://api.allorigins.win/raw?url=${encodeURIComponent(googleSheetBaseUrl + CORE_GID)}&timestamp=${new Date().getTime()}`;
            const response = await fetch(proxyUrl);
            
            if (!response.ok) throw new Error('æ ¸å¿ƒå­˜è‚¡ç¶²è·¯å›æ‡‰éŒ¯èª¤ã€‚');
            const data = await response.text();
            
            // ==============================================================
            // *** V30 åµéŒ¯æ¨¡å¼ï¼šé¡¯ç¤ºåŸå§‹ CSV è³‡æ–™ ***
            // è«‹å°‡æ­¤è™•é¡¯ç¤ºçš„å…§å®¹æˆªåœ–æˆ–è¤‡è£½çµ¦æˆ‘ï¼Œä»¥ä¾¿ç¢ºèªæ¬„ä½é †åºã€‚
            // ==============================================================
            
            document.getElementById('coreTableBody').innerHTML = `
                <tr><td colspan="8" style="background: #fff8e1; border: 1px solid #ffcc80; padding: 15px;">
                    <h4 style="color: #e65100;">ğŸš¨ åµéŒ¯æ¨¡å¼ï¼šåŸå§‹ CSV å…§å®¹ (è«‹ç¢ºèªæ¬„ä½èˆ‡è¡Œæ•¸)</h4>
                    <pre style="white-space: pre-wrap; word-break: break-all; font-size: 0.8em; text-align: left; max-height: 400px; overflow-y: auto;">${data}</pre>
                </td></tr>
            `;
            // *** åµéŒ¯æ¨¡å¼çµæŸ ***

            const now = new Date();
            document.getElementById('coreLastUpdated').innerText = `åµéŒ¯æ¨¡å¼ (è«‹æä¾› CSV å…§å®¹æˆªåœ–): ${now.getHours().toString().padStart(2,'0')}:${now.getMinutes().toString().padStart(2,'0')}:${now.getSeconds().toString().padStart(2,'0')}`;

        } catch (error) {
            console.error('æ ¸å¿ƒå­˜è‚¡è®€å–å¤±æ•—:', error);
            document.getElementById('coreTableBody').innerHTML = `<tr><td colspan="8" class="negative" style="text-align:center"><strong>ç¶²è·¯æˆ–è®€å–éŒ¯èª¤ï¼</strong><br>éŒ¯èª¤: ${error.message}</td></tr>`;
            document.getElementById('coreLastUpdated').innerText = 'æ›´æ–°å¤±æ•—';
        }
        
        // ç¢ºä¿åœ–è¡¨è¢«æ¸…ç©º
        if (coreChart1) coreChart1.destroy();
        if (coreChart2) coreChart2.destroy();
        if (coreChart3) coreChart3.destroy();
    }

    // (çœç•¥ updateCoreDashboard å’Œ updateCoreCharts å‡½æ•¸ï¼Œå› ç‚ºåœ¨åµéŒ¯æ¨¡å¼ä¸‹ä¸æœƒåŸ·è¡Œ)


    // =========================================================
    // å…±åŒå‡½æ•¸
    // =========================================================

    function sortTable(n) {
        // ... (æ’åºå‡½æ•¸ä¿æŒä¸è®Š)
        var table, rows, switching, i, x, y, shouldSwitch, dir, switchcount = 0;
        table = document.getElementById("holdingsTable");
        switching = true;
        dir = "asc";
        while (switching) {
            switching = false;
            rows = table.rows;
            for (i = 1; i < (rows.length - 1); i++) {
                shouldSwitch = false;
                x = rows[i].getElementsByTagName("TD")[n];
                y = rows[i + 1].getElementsByTagName("TD")[n];
                
                let xVal = x.innerHTML.replace(/,/g, '').replace(/%/g, '');
                let yVal = y.innerHTML.replace(/,/g, '').replace(/%/g, '');
                let isNum = !isNaN(parseFloat(xVal));

                if (dir == "asc") {
                    if (isNum ? (parseFloat(xVal) > parseFloat(yVal)) : (x.innerHTML.toLowerCase() > y.innerHTML.toLowerCase())) {
                        shouldSwitch = true;
                        break;
                    }
                } else if (dir == "desc") {
                    if (isNum ? (parseFloat(xVal) < parseFloat(yVal)) : (x.innerHTML.toLowerCase() < y.innerHTML.toLowerCase())) {
                        shouldSwitch = true;
                        break;
                    }
                }
            }
            if (shouldSwitch) {
                rows[i].parentNode.insertBefore(rows[i + 1], rows[i]);
                switching = true;
                switchcount ++;
            } else {
                if (switchcount == 0 && dir == "asc") {
                    dir = "desc";
                    switching = true;
                }
            }
        }
    }

    fetchData(); // åˆå§‹åŒ–è¼‰å…¥ä¸»å„€è¡¨æ¿
</script>

</body>
</html>
