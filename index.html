<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>即時投資組合儀表板 (最終修正版)</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <style>
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background-color: #f4f6f8; margin: 0; padding: 20px; }
        .container { max-width: 1200px; margin: 0 auto; }
        .header { background: #fff; padding: 20px; border-radius: 10px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); margin-bottom: 20px; display: flex; justify-content: space-between; align-items: center; }
        .header h1 { margin: 0; color: #333; font-size: 1.5rem; }
        .header p { color: #666; margin: 5px 0 0; font-size: 0.9rem; }
        .refresh-btn { background-color: #36a2eb; color: white; border: none; padding: 8px 15px; border-radius: 5px; cursor: pointer; transition: background 0.3s; }
        .refresh-btn:hover { background-color: #258cd1; }
       
        .kpi-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-bottom: 20px; }
        .kpi-card { background: #fff; padding: 20px; border-radius: 10px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); text-align: center; }
        .kpi-title { font-size: 0.9em; color: #888; margin-bottom: 5px; }
        .kpi-value { font-size: 1.5em; font-weight: bold; color: #333; }
        .positive { color: #28a745; }
        .negative { color: #dc3545; }

        .charts-container { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px; }
        .chart-card { background: #fff; padding: 20px; border-radius: 10px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
       
        .table-container { background: #fff; padding: 20px; border-radius: 10px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); overflow-x: auto; }
        table { width: 100%; border-collapse: collapse; margin-top: 10px; min-width: 600px; }
        th, td { padding: 12px; text-align: left; border-bottom: 1px solid #eee; }
        th { background-color: #f8f9fa; color: #555; cursor: pointer; user-select: none; }
        th:hover { background-color: #e9ecef; }
        tr:hover { background-color: #f1f1f1; }
        .loading { text-align: center; padding: 20px; color: #666; font-style: italic; }

        @media (max-width: 768px) {
            .charts-container { grid-template-columns: 1fr; }
            .header { flex-direction: column; align-items: flex-start; }
            .refresh-btn { margin-top: 10px; }
        }
    </style>
</head>
<body>

<div class="container">
    <div class="header">
        <div>
            <h1>個人證券資產分析總表</h1>
            <p>資料來源：Google 試算表 (即時連動) | <span id="lastUpdated">更新中...</span></p>
        </div>
        <button class="refresh-btn" onclick="fetchData()">重新整理</button>
    </div>

    <div class="kpi-grid">
        <div class="kpi-card">
            <div class="kpi-title">總投入成本</div>
            <div class="kpi-value" id="kpi-cost">-</div>
        </div>
        <div class="kpi-card">
            <div class="kpi-title">目前總市值</div>
            <div class="kpi-value" id="kpi-value">-</div>
        </div>
        <div class="kpi-card">
            <div class="kpi-title">帳面總損益</div>
            <div class="kpi-value" id="kpi-pl">-</div>
        </div>
        <div class="kpi-card">
            <div class="kpi-title">總報酬率</div>
            <div class="kpi-value" id="kpi-pct">-</div>
        </div>
    </div>

    <div class="charts-container">
        <div class="chart-card">
            <h3>前 10 大持倉 (按市值)</h3>
            <canvas id="topHoldingsChart"></canvas>
        </div>
        <div class="chart-card">
            <h3>主要獲利/虧損來源 (金額)</h3>
            <canvas id="plChart"></canvas>
        </div>
    </div>

    <div class="table-container">
        <h3>持股明細 (點擊標題可排序)</h3>
        <table id="holdingsTable">
            <thead>
                <tr>
                    <th onclick="sortTable(0)">代碼</th>
                    <th onclick="sortTable(1)">名稱</th>
                    <th onclick="sortTable(2)">庫存成本</th>
                    <th onclick="sortTable(3)">庫存現值</th>
                    <th onclick="sortTable(4)">庫存損益</th>
                    <th onclick="sortTable(5)">報酬率 %</th>
                </tr>
            </thead>
            <tbody id="tableBody">
                <tr><td colspan="6" class="loading">正在讀取 Google 試算表資料...</td></tr>
            </tbody>
        </table>
    </div>
</div>

<script>
    // 您的 Google Sheet CSV 連結 (已修正，目標是讓您直接開啟檔案也能成功)
    const googleSheetUrl = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vTfHLeQ3OVmKrVEQXUwD7VUiC5Hgnp8DORBJsL8Rs_434tzm7frIzs5hAsFsVgDL7fZM4ySENKHw5Fy/pub?gid=947201725&single=true&output=csv';
   
    let chartInstance1 = null;
    let chartInstance2 = null;

    // CSV 解析器：能處理包含逗號的數字
    function parseCSVLine(text) {
        const result = [];
        let startValueIndex = 0;
        let inQuotes = false;
       
        for (let i = 0; i < text.length; i++) {
            if (text[i] === '"') {
                inQuotes = !inQuotes;
            } else if (text[i] === ',' && !inQuotes) {
                let val = text.substring(startValueIndex, i);
                if (val.startsWith('"') && val.endsWith('"')) {
                    val = val.substring(1, val.length - 1);
                }
                result.push(val.trim());
                startValueIndex = i + 1;
            }
        }
        let val = text.substring(startValueIndex);
        if (val.startsWith('"') && val.endsWith('"')) {
            val = val.substring(1, val.length - 1);
        }
        result.push(val.trim());
        return result;
    }

    async function fetchData() {
        document.getElementById('tableBody').innerHTML = '<tr><td colspan="6" class="loading">正在更新資料...</td></tr>';
        document.getElementById('lastUpdated').innerText = '更新中...';

        try {
            // 使用 allorigins 作為 CORS 代理，並加上時間戳防止快取
            // 這是為了讓您在本地端開啟 HTML (file://) 時能成功讀取資料
            const proxyUrl = `https://api.allorigins.win/raw?url=${encodeURIComponent(googleSheetUrl)}&timestamp=${new Date().getTime()}`;
           
            const response = await fetch(proxyUrl);
           
            if (!response.ok) throw new Error('網路回應錯誤，可能發生 CORS 阻擋。');
           
            const data = await response.text();
           
            const rows = data.split(/\r\n|\n/).slice(1);
           
            const portfolioData = rows.map(row => {
                if (!row.trim()) return null;
               
                const cols = parseCSVLine(row);
               
                // 根據您的欄位順序，總共是 12 欄 (索引 0-11)
                if (cols.length < 12) return null;

                const cleanNum = (str) => parseFloat(str.replace(/,/g, '').replace(/%/g, '')) || 0;

                return {
                    code: cols[0],
                    name: cols[1],
                    // ******************** 關鍵修正處 ********************
                    cost: cleanNum(cols[8]),    // 庫存成本 (Index 8)
                    value: cleanNum(cols[9]),   // 庫存現值 (Index 9)
                    pl: cleanNum(cols[10]),     // 庫存損益 (Index 10)
                    pct: cleanNum(cols[11])     // 庫存損益% (Index 11)
                    // ****************************************************
                };
            }).filter(item => item !== null);

            updateDashboard(portfolioData);
           
            const now = new Date();
            document.getElementById('lastUpdated').innerText = `最後更新: ${now.getHours().toString().padStart(2,'0')}:${now.getMinutes().toString().padStart(2,'0')}:${now.getSeconds().toString().padStart(2,'0')}`;

        } catch (error) {
            console.error('讀取失敗:', error);
            document.getElementById('tableBody').innerHTML = `<tr><td colspan="6" class="negative" style="text-align:center">
                <strong>無法讀取資料！請確認網路連線或使用 Live Server 開啟。</strong><br>
                錯誤訊息: ${error.message}
            </td></tr>`;
            document.getElementById('lastUpdated').innerText = '更新失敗';
        }
    }

    function updateDashboard(data) {
        // 1. 計算總計
        const totalCost = data.reduce((acc, curr) => acc + curr.cost, 0);
        const totalValue = data.reduce((acc, curr) => acc + curr.value, 0);
        const totalPL = totalValue - totalCost;
        const totalPct = totalCost > 0 ? (totalPL / totalCost) * 100 : 0;

        // 2. 更新 KPI 卡片
        document.getElementById('kpi-cost').innerText = parseInt(totalCost).toLocaleString();
        document.getElementById('kpi-value').innerText = parseInt(totalValue).toLocaleString();
       
        const plEl = document.getElementById('kpi-pl');
        plEl.innerText = (totalPL > 0 ? '+' : '') + parseInt(totalPL).toLocaleString();
        plEl.className = `kpi-value ${totalPL >= 0 ? 'positive' : 'negative'}`;
       
        const pctEl = document.getElementById('kpi-pct');
        pctEl.innerText = (totalPct > 0 ? '+' : '') + totalPct.toFixed(2) + '%';
        pctEl.className = `kpi-value ${totalPct >= 0 ? 'positive' : 'negative'}`;

        // 3. 更新圖表
        updateCharts(data);

        // 4. 更新表格
        const tableBody = document.getElementById('tableBody');
        tableBody.innerHTML = '';
       
        data.forEach(item => {
            const row = document.createElement('tr');
            const plClass = item.pl >= 0 ? 'positive' : 'negative';
            row.innerHTML = `
                <td>${item.code}</td>
                <td>${item.name}</td>
                <td>${Math.round(item.cost).toLocaleString()}</td>
                <td>${Math.round(item.value).toLocaleString()}</td>
                <td class="${plClass}">${Math.round(item.pl).toLocaleString()}</td>
                <td class="${plClass}">${item.pct.toFixed(2)}%</td>
            `;
            tableBody.appendChild(row);
        });
    }

    function updateCharts(data) {
        if (chartInstance1) chartInstance1.destroy();
        if (chartInstance2) chartInstance2.destroy();

        const sortedByValue = [...data].sort((a, b) => b.value - a.value).slice(0, 10);
        chartInstance1 = new Chart(document.getElementById('topHoldingsChart'), {
            type: 'bar',
            data: {
                labels: sortedByValue.map(i => i.name),
                datasets: [{
                    label: '庫存現值',
                    data: sortedByValue.map(i => i.value),
                    backgroundColor: '#36a2eb',
                    borderRadius: 4
                }]
            },
            options: {
                indexAxis: 'y',
                responsive: true,
                maintainAspectRatio: false,
                plugins: { legend: { display: false } }
            }
        });

        const sortedByPL = [...data].sort((a, b) => b.pl - a.pl);
        const topGainers = sortedByPL.slice(0, 5);
        const topLosers = sortedByPL.slice(-5);
        const plChartData = [...new Set([...topGainers, ...topLosers])].sort((a, b) => b.pl - a.pl);
       
        chartInstance2 = new Chart(document.getElementById('plChart'), {
            type: 'bar',
            data: {
                labels: plChartData.map(i => i.name),
                datasets: [{
                    label: '損益金額',
                    data: plChartData.map(i => i.pl),
                    backgroundColor: plChartData.map(i => i.pl >= 0 ? '#28a745' : '#dc3545'),
                    borderRadius: 4
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: { legend: { display: false } }
            }
        });
    }

    function sortTable(n) {
        var table, rows, switching, i, x, y, shouldSwitch, dir, switchcount = 0;
        table = document.getElementById("holdingsTable");
        switching = true;
        dir = "asc";
        while (switching) {
            switching = false;
            rows = table.rows;
            for (i = 1; i < (rows.length - 1); i++) {
                shouldSwitch = false;
                x = rows[i].getElementsByTagName("TD")[n];
                y = rows[i + 1].getElementsByTagName("TD")[n];
               
                let xVal = x.innerHTML.replace(/,/g, '').replace(/%/g, '');
                let yVal = y.innerHTML.replace(/,/g, '').replace(/%/g, '');
                let isNum = !isNaN(parseFloat(xVal));

                if (dir == "asc") {
                    if (isNum ? (parseFloat(xVal) > parseFloat(yVal)) : (x.innerHTML.toLowerCase() > y.innerHTML.toLowerCase())) {
                        shouldSwitch = true;
                        break;
                    }
                } else if (dir == "desc") {
                    if (isNum ? (parseFloat(xVal) < parseFloat(yVal)) : (x.innerHTML.toLowerCase() < y.innerHTML.toLowerCase())) {
                        shouldSwitch = true;
                        break;
                    }
                }
            }
            if (shouldSwitch) {
                rows[i].parentNode.insertBefore(rows[i + 1], rows[i]);
                switching = true;
                switchcount ++;
            } else {
                if (switchcount == 0 && dir == "asc") {
                    dir = "desc";
                    switching = true;
                }
            }
        }
    }

    fetchData();
</script>

</body>
</html>
